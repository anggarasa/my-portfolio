; ==============================================================================
; PHP-FPM Pool Configuration
; Optimized for VPS with 2-4GB RAM
; ==============================================================================

[www]
; User and group for worker processes
user = www-data
group = www-data

; Listen on TCP port instead of socket for easier debugging
listen = 127.0.0.1:9000

; Owner and permissions for socket (used if using socket)
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; ==============================================================================
; Process Management (Dynamic for low-memory VPS)
; ==============================================================================
pm = dynamic

; Maximum number of child processes
; For 2-4GB RAM: set this to (RAM in MB / 30) - reserve for other processes
; 2GB = ~50, but we limit to 20 for safety
pm.max_children = 20

; Number of child processes created on startup
; Start with minimal processes to save memory
pm.start_servers = 5

; Minimum number of idle server processes
pm.min_spare_servers = 3

; Maximum number of idle server processes
pm.max_spare_servers = 10

; Number of requests a child process will serve before respawning
; Helps prevent memory leaks
pm.max_requests = 500

; ==============================================================================
; Timeouts and Limits
; ==============================================================================

; Maximum execution time (in seconds)
request_terminate_timeout = 300

; Slowlog threshold (in seconds)
slowlog = /proc/self/fd/2
request_slowlog_timeout = 10s

; ==============================================================================
; Resource Limits
; ==============================================================================

; Maximum memory a single process can use
; This should match php.ini memory_limit
php_admin_value[memory_limit] = 512M

; Maximum upload file size
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M

; ==============================================================================
; Error Logging
; ==============================================================================

; Log errors to stderr (captured by Docker)
php_admin_value[error_log] = /proc/self/fd/2
php_admin_flag[log_errors] = on

; Environment variables to keep
clear_env = no

; Ensure all workers start with a clean environment
catch_workers_output = yes
decorate_workers_output = no
