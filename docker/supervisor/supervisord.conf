; ==============================================================================
; Supervisord Configuration for Laravel Production
; Manages PHP-FPM, Nginx, and Queue Worker processes
; ==============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/run/supervisord.pid
loglevel=info

; ==============================================================================
; PHP-FPM Process
; ==============================================================================
[program:php-fpm]
command=/usr/local/sbin/php-fpm -F
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
priority=5
startretries=3
startsecs=5

; ==============================================================================
; Nginx Process
; ==============================================================================
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
priority=10
startretries=3
startsecs=5

; ==============================================================================
; Laravel Queue Worker (DISABLED)
; Uncomment the section below to enable queue worker
;
; Configuration notes:
; - Uses 'database' connection by default (change if using Redis)
; - Limited to 1 worker to conserve RAM on small VPS
; - Sleeps 3 seconds between job polls when queue is empty
; - Memory limit helps prevent memory leaks
; - Timeout prevents stuck jobs
; ==============================================================================
; [program:laravel-queue]
; command=/usr/local/bin/php /var/www/html/artisan queue:work database --sleep=3 --tries=3 --max-time=3600 --memory=128
; directory=/var/www/html
; user=www-data
; numprocs=1
; stdout_logfile=/dev/stdout
; stdout_logfile_maxbytes=0
; stderr_logfile=/dev/stderr
; stderr_logfile_maxbytes=0
; autostart=true
; autorestart=true
; priority=20
; startretries=3
; startsecs=5
; stopwaitsecs=30

; ==============================================================================
; Laravel Scheduler (Optional - uses cron instead if you prefer)
; Runs the Laravel scheduler every minute
;
; Uncomment the following block if you want supervisord to manage the scheduler
; instead of using cron
; ==============================================================================
; [program:laravel-scheduler]
; command=/bin/sh -c "while [ true ]; do php /var/www/html/artisan schedule:run --verbose --no-interaction & sleep 60; done"
; directory=/var/www/html
; user=www-data
; numprocs=1
; stdout_logfile=/dev/stdout
; stdout_logfile_maxbytes=0
; stderr_logfile=/dev/stderr
; stderr_logfile_maxbytes=0
; autostart=true
; autorestart=true
; priority=25
; startretries=3
; startsecs=0
